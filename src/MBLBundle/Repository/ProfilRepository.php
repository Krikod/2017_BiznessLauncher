<?php

namespace MBLBundle\Repository;

/**
 * ProfilRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class ProfilRepository extends \Doctrine\ORM\EntityRepository
{
    /**
     * @param $locale
     * @return array
     */
    public function findLastProfils4($locale)
    {
        $qb = $this->createQueryBuilder('p');
        $qb->select('p.id as id', 'p.prenom as prenom', 'p.description as description', 'p.localisation as localisation', 'p.nom as nom', 'p.ville as ville')
            ->where('p.lng = :locale')
            ->setParameter('locale', $locale)
            ->join('p.metier', 'm')
            ->addSelect('m.metier' . $locale . ' as metier')
            ->setMaxResults(4)
            ->orderBy('p.id', 'DESC')
        ;

        $profils = $qb->getQuery()->getResult();
        foreach ($profils as $key => $profil)
        {
//            Get metier et création d'un sous tableau'
            $qb = $this->createQueryBuilder('p');
            $qb->where('p.id = :id')
                ->join('p.metier', 'm')
                ->select('m.metier' . $locale . ' as metier')
                ->setParameter('id', $profil['id']);
            $profils[$key]['metier'] = $qb->getQuery()->getOneOrNullResult();

//            Get fichier si défini et si null
            $qb = $this->createQueryBuilder('p');
            $qb->where('p.id = :id')
                ->join('p.fichier', 'f')
                ->select('f.photo')
                ->setParameter('id', $profil['id']);;
            $profils[$key]['fichier'] = $qb->getQuery()->getResult();

//            Get compétences si défini et si null
            $qb = $this->createQueryBuilder('p');
            $qb->where('p.id = :id')
                ->join('p.competences', 'c')
                ->select('c.competences' . $locale . ' as competence')
                ->setParameter('id', $profil['id']);;
            $profils[$key]['competences'] = $qb->getQuery()->getResult();

        }

        /*dump($projets); die();*/

        return $profils;
    }

    public function myfindByMetLoc($idMetier, $idLoc)
    {
        return $this ->createQueryBuilder('p')
            ->select('p')
            ->join('p.metier', 'pmet')
            ->where('pmet.metier = :met')
            ->setParameter('met', $idMetier)
            ->andWhere('p.localisation = :secteurId')
            ->setParameter('secteurId', $idLoc)
            ->getQuery()
            ->getResult();// TODO: Change the autogenerated stub
    }
    public function myfindByMet($idMetier)
    {
        return $this ->createQueryBuilder('p')
            ->select('p')
            ->join('p.metier', 'pmet')
            ->where('pmet.id = :met')
            ->setParameter('met', $idMetier)
            ->getQuery()
            ->getResult();// TODO: Change the autogenerated stub
    }
}
